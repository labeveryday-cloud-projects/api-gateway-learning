# **Video Transcription Service Using AWS SAM, Step Functions, and Amazon Transcribe**

This project provides a serverless solution for uploading videos, transcribing them using Amazon Transcribe, and saving the transcription results back into S3. It leverages **AWS SAM** (Serverless Application Model) to deploy Lambda functions, Step Functions, S3 buckets, and Cognito for user authentication, while allowing secure video uploads using **pre-signed URLs**.

## **Table of Contents**
- [Architecture Overview](#architecture-overview)
- [Prerequisites](#prerequisites)
- [Setup and Deployment](#setup-and-deployment)
- [Lambda Functions Overview](#lambda-functions-overview)
- [Step Functions](#step-functions)
- [Cognito User Pool](#cognito-user-pool)
- [Usage](#usage)
- [Security Considerations](#security-considerations)
- [Testing and Troubleshooting](#testing-and-troubleshooting)
- [Future Enhancements](#future-enhancements)
- [License](#license)

---

## **Architecture Overview**

This application consists of the following components:

1. **Amazon Cognito**: Manages user authentication and authorization.
2. **Amazon S3**: 
   - `VideoUploadBucket`: Stores the uploaded videos.
   - `TranscriptionOutputBucket`: Stores the transcription results.
3. **AWS Lambda**:
   - **GeneratePreSignedUrlFunction**: Generates a pre-signed URL for the front end to upload a video to S3.
   - **StartTranscriptionFunction**: Starts a transcription job using Amazon Transcribe.
   - **SaveTranscriptionResultFunction**: Saves the transcription result to S3.
4. **Step Functions**: Orchestrates the entire workflow from video upload to transcription and saving the output.
5. **Amazon Transcribe**: Transcribes the uploaded videos and returns text transcripts.

### **High-Level Workflow**:

1. The user uploads a video file to S3 using a pre-signed URL generated by the `GeneratePreSignedUrlFunction`.
2. When a video is uploaded to S3, the Step Function is triggered. It starts by invoking the `StartTranscriptionFunction` to submit the video to Amazon Transcribe.
3. Once transcription is completed, the `SaveTranscriptionResultFunction` stores the transcription result in S3.
4. The process completes when the transcription is saved to the `TranscriptionOutputBucket`.

---

## **Prerequisites**

Before deploying the application, ensure you have the following:

1. **AWS Account** with access to create and manage Lambda, S3, Step Functions, Transcribe, and Cognito.
2. **AWS CLI** installed and configured with credentials (`aws configure`).
3. **AWS SAM CLI** installed ([Install SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html)).
4. **Python 3.9+** installed (for the Lambda functions).

---

## **Setup and Deployment**

### **1. Clone the Repository**
```bash
git clone <repository-url>
cd <repository-folder>
```

### **2. Build and Deploy the Application Using AWS SAM**

1. **Build the SAM application**:
   ```bash
   sam build
   ```

2. **Deploy the SAM application**:
   ```bash
   sam deploy --guided
   ```

   The deploy command will prompt you to provide several configuration options:
   - **Stack name**: Enter a name for your CloudFormation stack (e.g., `VideoTranscriptionApp`).
   - **AWS Region**: Choose the AWS region for deployment (e.g., `us-east-1`).
   - **Confirm changes**: Answer `yes` to deploy the resources.

### **3. Outputs**

After deployment, SAM will provide key outputs like:
- The **API Gateway URL** for generating pre-signed URLs.
- The **Cognito User Pool ID** and **Client ID** for authentication.

---

## **Lambda Functions Overview**

### **1. Generate Pre-Signed URL Lambda**

**Purpose**: Generates a pre-signed URL for clients to upload video files securely to S3.

- **Handler**: `generate_presigned_url.lambda_handler`
- **Inputs**: `file_name` as a query string parameter.
- **Outputs**: A pre-signed URL valid for 1 hour.

### **2. Start Transcription Lambda**

**Purpose**: Starts an Amazon Transcribe job for the video uploaded to S3.

- **Handler**: `start_transcription.lambda_handler`
- **Inputs**: Triggered by an S3 event when a video file is uploaded.
- **Outputs**: Initiates the Transcribe job and returns the job details.

### **3. Save Transcription Result Lambda**

**Purpose**: Retrieves the transcription result from Amazon Transcribe and stores it in the `TranscriptionOutputBucket`.

- **Handler**: `save_transcription_result.lambda_handler`
- **Inputs**: Transcription result from Amazon Transcribe.
- **Outputs**: Saves the transcription text in the output S3 bucket.

---

## **Step Functions**

The **Step Functions** workflow orchestrates the transcription process. It includes two key steps:
1. **StartTranscription**: Invokes the Lambda to start the transcription job.
2. **SaveResult**: Once transcription is complete, this step saves the result to S3.

---

## **Cognito User Pool**

The application uses **Amazon Cognito** for user authentication and authorization. Users need to sign in to obtain temporary credentials before they can upload files to S3.

### **Cognito Configuration**:
- **User Pool**: `VideoAppUserPool`
- **App Client**: `VideoAppUserClient`

After deployment, you'll need to integrate the **Cognito User Pool** with your front end to handle sign-up, sign-in, and obtaining tokens for authenticated S3 uploads.

---

## **Usage**

### **1. User Authentication**
Users must sign in to obtain credentials from Cognito. After successful authentication, they can interact with the application.

### **2. Generate Pre-Signed URL**
Make an HTTP `GET` request to the API Gateway endpoint with a file name to generate a pre-signed URL:

```bash
curl -X GET "https://<API-Gateway-URL>/generate-presigned-url?file_name=example.mp4"
```

The API will return a URL to upload the video directly to the S3 bucket.

### **3. Upload Video**
Use the returned pre-signed URL to upload the video from your front end. For example, in JavaScript:

```javascript
const file = document.getElementById('fileInput').files[0];
const presignedUrl = '<URL from step 2>';
fetch(presignedUrl, {
  method: 'PUT',
  body: file,
})
  .then(response => {
    if (response.ok) {
      console.log('Upload successful');
    } else {
      console.log('Upload failed');
    }
  });
```

### **4. View Transcription Results**
Once the video is uploaded, the transcription process is triggered, and the output will be saved in the **TranscriptionOutputBucket**. You can access the transcription results directly from S3.

---

## **Security Considerations**

- **Cognito Authentication**: Ensure only authenticated users can upload videos to S3 by managing access via Cognito.
- **S3 Bucket Permissions**: Follow the principle of least privilege when assigning roles to Lambda functions and ensure the S3 bucket is secure.
- **Pre-Signed URL Expiry**: Pre-signed URLs should have short expiry times (1 hour in this case) to prevent unauthorized uploads.

---

## **Testing and Troubleshooting**

1. **Testing Lambda Functions**: You can test Lambda functions directly via the AWS Console or SAM CLI.
   
   Example:
   ```bash
   sam local invoke GeneratePresignedUrlFunction
   ```

2. **CloudWatch Logs**: All Lambda function logs are sent to CloudWatch Logs. Use CloudWatch to troubleshoot issues by checking log groups.

3. **Step Functions Monitoring**: Use the Step Functions dashboard in the AWS Console to track and debug execution failures.

---

## **Future Enhancements**

- **Video Formats**: Add support for more video formats in the transcription process.
- **Front End**: Integrate with a front end for a seamless upload and transcription experience.
- **Notifications**: Add an SNS topic to notify users when the transcription process is complete.
